<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

  <link href="style.css" rel="stylesheet" />
  <title>VAMS Checklist</title>
  <link rel="icon" href="https://afiqrostam.github.io/vams-checklist/icon.png" size="64x64" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>

<body class="bg-light">
  <!-- modal -->
  <div id="newPage" class="bg-white modal fade" aria-hidden="true" aria-labelledby="newPage" data-bs-keyboard="false"
    data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-scrollable modal-xl">
      <!-- open faults -->
      <div id="openjobmodal">
        <div v-if="loaded == true" class="modal-content">
          <div class="modal-body min-vh-85">
            <div class="list-group">
              <div class="list-group-item list-group-item-action list-group-item-dark " aria-current="true">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mt-3 mb-2">Open Jobs</h5>
                </div>
              </div>
              <div class="list-group-item list-group-item-action" v-for="dt in getCurrent()" :key="dt['evt_code']"
                :id="'JOBS_'+dt['evt_code']">
                <div class="hstack gap-2">
                  <div class="vstack gap-1">
                    <span>{{ dt['evt_desc'] }}</span>
                    <small class="text-muted">{{ dt['evt_status_desc'] }}</small>
                  </div>
                  <small v-if="get_days(dt) > 1" class="ms-auto text-muted">{{ get_days(dt) }} days ago</small>
                  <small v-else class="ms-auto text-muted">{{ get_days(dt) }} day ago</small>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-body ">
            <nav>
              <ul class="pagination justify-content-center">
                <li :class="counter <= 0 ?'page-item disabled':'page-item'" @click="delCount">
                  <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <li v-show="counter + 1  <= maxCount" :class="(counter + 1 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 1)">
                  <a class="page-link" href="#">{{counter + 1}}</a>
                </li>
                <li v-show="counter + 2  <= maxCount" :class="(counter + 2 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 2)"><a class="page-link" href="#">{{counter + 2}}</a></li>
                <li v-show="counter + 3  <= maxCount" :class="(counter + 3 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 3)">
                  <a class="page-link" href="#">{{counter + 3}}</a>
                </li>
                <li v-show="counter + 4  <= maxCount" :class="(counter + 4 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 4)">
                  <a class="page-link" href="#">{{counter + 4}}</a>
                </li>
                <li v-show="counter + 5  <= maxCount" :class="(counter + 5 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 5)">
                  <a class="page-link" href="#">{{counter + 5}}</a>
                </li>
                <li :class="counter + 5  >= maxCount ?'page-item disabled':'page-item'" @click="addCount">
                  <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
          <div class="modal-footer">
            <button type="button" @click="closeModal" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
      <!-- photo -->
      <div id="photomodal">
        <div v-if="loaded == true" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Photo</h5>
          </div>
          <div v-if="!getChecklistStatus()" class="modal-body d-flex justify-content-center">
            click on camera icon or exisiting image to take a photo
          </div>
          <div class="modal-body min-vh-75 d-flex justify-content-center">
            <div class="card border-0 col-12 col-md-9 p-3" @click="openFile">
              <div v-if="data.loaded" class="m-auto spinner-grow" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <template v-else>
                <div v-if="data.src === ''" class="card h-100 border-0">
                  <i class="m-auto big-3 bi bi-camera-fill"></i>
                </div>
                <img v-else class="my-auto rounded" :src="data.src">
              </template>
            </div>
            <input class="d-none" id="new_photo_btn" @change="processImg($event)" type="file" accept="image/*">
          </div>
          <div class="modal-footer">
            <button type="button" v-if="!getChecklistStatus() && data.src !== ''" @click="uploadPhoto"
              class="btn btn-primary">Save</button>
            <button type="button" @click="closeModal" id="photo_close_btn" class="btn btn-secondary"
              data-bs-dismiss="modal">Cancel</button>
            <button type="button" v-if="!getChecklistStatus() && data.photoid !== '' && data.checklistid !==''"
              @click="deletePhoto" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
      <!-- past dvr -->
      <div id="pastdvrmodal">
        <div v-if="loaded == true" class="modal-content">
          <div class="modal-body  min-vh-85">
            <div class="list-group">
              <div class="list-group-item list-group-item-action list-group-item-dark " aria-current="true">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mt-3 mb-2">Past DVRs</h5>
                </div>
              </div>
              <div class="list-group-item list-group-item-action" v-for="dt in getCurrent()" :key="dt['dae_document']"
                :id="'FORMS_'+dt['dae_document']">
                <div class="hstack gap-2 mb-1">
                  <div class="hstack gap-1">
                    <button @click="download(dt)" :class="'btn btn-primary '+[dt['url'] == undefined ?'disabled':'']"
                      :id="'PREV_'+dt['dae_document']">
                      <span v-if="dt['url'] == undefined " class="spinner-grow spinner-grow-sm" role="status"
                        aria-hidden="true"></span>
                      <i v-else class="bi bi-file-earmark-pdf-fill"></i>
                    </button>
                    <button @click="downloadfile(dt)" v-if="!isMob()"
                      :class="'btn btn-primary '+[dt['url'] == undefined ?'disabled':'']"
                      :id="'LINK_'+dt['dae_document']">
                      <span v-if="dt['url'] == undefined " class="spinner-grow spinner-grow-sm" role="status"
                        aria-hidden="true"></span>
                      <i v-else class="bi bi-archive-fill"></i>
                    </button>
                    <a target="_blank" :href="[ dt['url'] == undefined ? '#' : dt['url']]" v-if="isMob()"
                      :class="'btn btn-primary '+[dt['url'] == undefined ?'disabled':'']"
                      :id="'LINKMOB_'+dt['dae_document']">
                      <span v-if="dt['url'] == undefined " class="spinner-grow spinner-grow-sm" role="status"
                        aria-hidden="true"></span>
                      <i v-else class="bi bi-archive-fill"></i>
                    </a>
                    {{ dt['ock_startdate'] }}
                  </div>
                  <small v-if="get_days(dt) > 1" class="ms-auto text-muted">{{ get_days(dt) }} days ago</small>
                  <small v-else class="ms-auto text-muted">{{ get_days(dt) }} day ago</small>
                </div>
                <div :id="'FRAME_'+dt['dae_document']"></div>
              </div>
            </div>
          </div>
          <div class="modal-body ">
            <nav>
              <ul class="pagination justify-content-center">
                <li :class="counter <= 0 ?'page-item disabled':'page-item'" @click="delCount">
                  <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <li v-show="counter + 1  <= maxCount" :class="(counter + 1 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 1)">
                  <a class="page-link" href="#">{{counter + 1}}</a>
                </li>
                <li v-show="counter + 2  <= maxCount" :class="(counter + 2 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 2)"><a class="page-link" href="#">{{counter + 2}}</a></li>
                <li v-show="counter + 3  <= maxCount" :class="(counter + 3 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 3)">
                  <a class="page-link" href="#">{{counter + 3}}</a>
                </li>
                <li v-show="counter + 4  <= maxCount" :class="(counter + 4 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 4)">
                  <a class="page-link" href="#">{{counter + 4}}</a>
                </li>
                <li v-show="counter + 5  <= maxCount" :class="(counter + 5 ) == current ?'page-item active':'page-item'"
                  @click="setCurrent(counter + 5)">
                  <a class="page-link" href="#">{{counter + 5}}</a>
                </li>
                <li :class="counter + 5  >= maxCount ?'page-item disabled':'page-item'" @click="addCount">
                  <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
          <div class="modal-footer">
            <button type="button" @click="closeModal" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- nav -->
  <div class="container-fluid bg-secondary bg-opacity-25 p-2  hstack gap-2 fixed-top">
    <div class="ms-auto dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-menu-button-wide"></i>
      </button>
      <ul class="dropdown-menu">
        <li>
          <a class="dropdown-item disabled" href="#" id="openjobmodalbutton" data-bs-toggle="modal"
            data-bs-target="#newPage">
            <span class="hstack gap-2">
              Open Faults&nbsp;
              <span class="badge text-bg-dark" id="openjobmodalcount">&nbsp;</span>
            </span>
          </a>
        </li>
        <li>
          <a class="dropdown-item disabled" href="#" id="pastdvrmodalbutton" data-bs-toggle="modal"
            data-bs-target="#newPage">
            <span class="hstack gap-2">
              Past DVR&nbsp;
              <span class="badge text-bg-dark" id="pastdvrmodalcount">&nbsp;</span>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
  <!-- alert -->
  <div id="alert" class="container fixed-bottom p-1">
    <div :id="data.id" v-for="data in datas" :key="data.id"
      v-bind="{ 'class': 'lh-sm my-1 alert text-light opacity-85 alert-dismissible fade show pre-line '+data.classfix }">
      {{ data.text }}
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"
        @click="remove(data)"></button>
    </div>
  </div>
  <div class="container my-5">
    &nbsp;
  </div>
  <!-- main -->
  <div id="check" class="container p-1">
    <div class="min-vh-95 d-flex align-items-center justify-content-center" v-if="loaded == false">
      <div class="spinner-grow text-dark" role="status" v-show="broken == false">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="fs-1 text-center lead" v-show="broken == true">
        <i class="bi bi-cloud-lightning-rain big"></i>
        <p>Oh no! Something broken</p>
      </div>
    </div>
    <div v-else>
      <div class="alert alert-info alert-dismissible fade show mb-2">
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        <div class="small">
          <ul class="list-unstyled px-1 m-0">
            <li>When updating, the tickbox on each checklist items indicates:</li>
            <li><i class="bi bi-circle pe-2"></i><span>unanswered checklist;</span></li>
            <li><i class="bi bi-circle text-info pe-2"></i><span>unanswered checklist synced to VAMS;</span></li>
            <li><i class="bi bi-check-circle pe-2"></i><span>answered checklist;</span></li>
            <li><i class="bi bi-check-circle-fill text-info pe-2"></i><span>answered checklist synced to VAMS;</span>
            </li>
          </ul>
        </div>
      </div>
      <div class="vstack gap-2" v-if="form != true">
        <button @click="loadForm" type="button" class="btn btn-primary" v-if="data.length != 0 " :id="dt['ock_code']"
          v-for="dt in data" :key="dt['ock_code']">
          {{ dt['trunc_ock_startdate'] + ' ' + dt['state'] + ' (' + dt['ock_status_desc'] + ')'}}
        </button>
        <button @click="newForm" type="button" class="btn btn-primary" v-if="new_form" id="new_checklist">New
          DVR</button>
      </div>
    </div>
  </div>

  <!-- checklist -->
  <div id="form">
    <div id="form-container" class="container p-1 mb-5" v-if="loaded == true">
      <div class="min-vh-95 d-flex align-items-center justify-content-center" v-if="Object.keys(data).length == 0">
        <div class="spinner-grow text-dark" role="status" v-show="broken == false">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="fs-1 text-center lead" v-show="broken == true">
          <i class="bi bi-cloud-lightning-rain big"></i>
          <p>Oh no! Something broken</p>
        </div>
      </div>
      <div class="card" v-else>
        <div class="accordion accordion-flush" :id="data.id">
          <div class="accordion-item" v-for="( activity, index ) in data.activities" :key="activity.id">
            <div class="accordion-header" :id="'h'+activity.id">
              <button :class="'accordion-button bg-light py-3 '+[ index == 0 ? '' : 'collapsed']" type="button"
                data-bs-toggle="collapse" aria-expanded="false"
                v-bind="{ 'data-bs-target': '#c'+activity.id, 'aria-controls': 'c'+activity.id }" @click="loadMeta()">
                <span class="h6 p-0 m-0">{{ activity.act_note}}</span>
              </button>
            </div>
            <div
              v-bind="{ 'id': 'c'+activity.id, 'aria-labelledby': 'h'+activity.id, 'data-bs-parent': '#'+activity.parentid }"
              :class="'accordion-collapse collapse '+[ index == 0 ? 'show' : '']">
              <template v-if="activity.groups !== undefined">
                <div class="accordion accordion-flush" :id="activity.id">
                  <div class="accordion-item" v-for="group in activity.groups" :key="group.id">
                    <div class="accordion-header" :id="'h'+group.id">
                      <button class="accordion-button py-2 bg-secondary bg-opacity-25 collapsed" type="button"
                        data-bs-toggle="collapse" aria-expanded="false"
                        v-bind="{ 'data-bs-target': '#c'+group.id, 'aria-controls': 'c'+group.id }" @click="loadMeta()">
                        <span class="w-100">{{ group.group_label}}</span>
                        <span class="small fw-light pe-2 text-nowrap">( {{ getGroupCompleted(group) }} of {{
                          group.items.filter(function(j){return j.ack_requiredtoclose === 'YES' ||
                          (j.ack_requiredtoclose === 'NO' && j.updated === true)}).length}} done )</span>
                      </button>
                    </div>
                    <div
                      v-bind="{ 'id': 'c'+group.id, 'aria-labelledby': 'h'+group.id, 'data-bs-parent': '#'+group.parentid }"
                      class="accordion-collapse collapse">
                      <template v-if="group.items !== undefined">
                        <div class="accordion accordion-flush" :id="group.id">
                          <div class="accordion-item bg-light"
                            v-if="(group.group_code === 'F-200104' || group.group_code === 'F-200102')">
                            <div class="accordion-body py-2 row text-body-tertiary small">
                              <span class="col-12 col-sm-4 col-md-4 hstack gap-1">
                                <i class="bi bi-check-square-fill"></i>
                                <span class="lh-1">No Obvious Defect / Done</span>
                              </span>
                              <span class="col-12 col-sm-4 col-md-3 hstack gap-1">
                                <i class="bi bi-x-square-fill"></i>
                                <span class="lh-1">Fault Identified</span>
                              </span>
                              <span class="col-12 col-sm-4 col-md-3 hstack gap-1">
                                <i class="bi bi-slash-square-fill"></i>
                                <span class="lh-1">Not Applicable</span>
                              </span>
                            </div>
                          </div>
                          <div :class="'accordion-item '+[getdisplay(item) ? '' : 'd-none']" v-for="item in group.items"
                            :key="item.ack_code">
                            <div class="accordion-body py-2 row">
                              <div class="col col-md-4 d-flex align-items-center"
                                v-if="['03','04','13','14','15'].indexOf(item.ack_type) != -1">
                                <span>{{ item.ack_desc }}</span>
                                <p v-if="item.ack_taskchecklistcode_comments != ''" class="pre-line m-0">{{
                                  item.ack_taskchecklistcode_comments }}</p>
                                <template v-else></template>
                                <span v-if="getStartReading(item) !== '' && !data.status"
                                  class="ps-2 ms-md-auto text-muted small">{{parseInt(getStartReading(item),10).toLocaleString()}}
                                  {{ item.ack_uom
                                  }}</span>

                                <template v-else></template>
                              </div>
                              <div class="col-md hstack gap-2 fw-light"
                                v-if="['03','04','13','14','15'].indexOf(item.ack_type) != -1">
                                <input v-if="item.ack_type == 13" type="date"
                                  class="form-control border-0 border-bottom" :id="'FREE'+item.ack_code"
                                  autocomplete="off" v-model="item.ack_checklistdate" @input="snycItems(item,$event)"
                                  @focus="snycItems(item,$event)" @keyup="snycItems(item,$event)"
                                  :disabled="data.status">
                                <input v-if="item.ack_type == 14" type="datetime-local"
                                  class="form-control border-0 border-bottom" :id="'FREE'+item.ack_code"
                                  autocomplete="off" v-model="item.ack_checklistdatetime"
                                  @input="snycItems(item,$event)" @focus="snycItems(item,$event)"
                                  @keyup="snycItems(item,$event)" :disabled="data.status">
                                <input v-if="item.ack_type == 15" type="text"
                                  class="form-control border-0 border-bottom" :id="'FREE'+item.ack_code"
                                  autocomplete="off" v-model="item.ack_freetext" @input="snycItems(item,$event)"
                                  @focus="snycItems(item,$event)" @keyup="snycItems(item,$event)"
                                  :disabled="data.status || ['Unit/Fleet No','Registration No','Worker Name'].indexOf(item.ack_desc) != -1">
                                <div class="input-group" v-if="item.ack_type == '04'">
                                  <input type="number" v-model="item.ack_value" @input="snycItems(item,$event)"
                                    @focus="snycItems(item,$event)" @keyup="snycItems(item,$event)"
                                    class="form-control border-0 border-end border-bottom" :placeholder="item.ack_desc"
                                    :disabled="data.status" :id="'FREE'+item.ack_code">
                                  <span class="input-group-text border-0 bg-light border-bottom">{{ item.ack_uom
                                    }}</span>
                                </div>
                                <div v-if="item.ack_type == 03" class="my-2 hstack gap-2">
                                  <div class="col d-none">
                                    <input type="radio" v-model="item.ack_finding"
                                      :id="'FREE'+item.ack_code+'_chk_null'" value="" autocomplete="off" checked>
                                  </div>
                                  <div class="col" v-for="option in item.ack_possiblefindings">
                                    <input type="radio" class="btn-check" @change="snycItems(item,$event)"
                                      v-model.lazy="item.ack_finding" :id="'FREE'+item.ack_code+'_chk_'+option.value"
                                      :value="option.value" autocomplete="off" :disabled="data.status">
                                    <label class="btn btn-outline-primary"
                                      :for="'FREE'+item.ack_code+'_chk_'+option.value"
                                      v-html="getOptionHTML(option.value)"></label>
                                  </div>
                                  <span v-if="item.ack_finding == 'Z029' && !data.status"
                                    class="hstack small text-danger gap-2"><i class="bi bi-exclamation-circle-fill"></i>
                                    Enter faults identified in the Faults
                                    section </span>
                                </div>
                                <button type="button" :id="'REFRESH'+item.ack_code" v-show="!data.status"
                                  :class="'ms-auto btn btn-sm rounded-circle btn-outline-secondary '+[ ['Unit/Fleet No','Registration No','Worker Name'].indexOf(item.ack_desc) != -1 ? ' d-none' : '']"
                                  @click="resetItems(item,$event)"><i class="bi bi-arrow-repeat"></i></button>
                                <i class="bi bi-circle pe-2"
                                  v-if="!getItemCompleted(item) && !item.updated && !item.process"></i>
                                <i class="bi bi-circle-fill pe-2"
                                  v-if="!getItemCompleted(item) && item.updated && !item.process"></i>
                                <i class="bi bi-circle text-info pe-2"
                                  v-if="!getItemCompleted(item) && item.updated && item.process"></i>
                                <i class="bi bi-check-circle pe-2"
                                  v-if="getItemCompleted(item) && !item.updated && !item.process"></i>
                                <i class="bi bi-check-circle-fill pe-2"
                                  v-if="getItemCompleted(item) && item.updated && !item.process"></i>
                                <i class="bi bi-check-circle-fill text-info pe-2"
                                  v-if="getItemCompleted(item) && item.updated && item.process"></i>
                              </div>
                              <div class="hstack gap-2 fw-light" v-if="['01'].indexOf(item.ack_type) != -1">
                                <input type="checkbox" class="btn-check" :id="'FREE'+item.ack_code" autocomplete="off"
                                  v-model="item.ack_completed" true-value="+" false-value="-" :disabled="data.status"
                                  @change="snycItems(item,$event)">
                                <label class="btn btn-outline-primary d-block" :for="'FREE'+item.ack_code"><i
                                    class="bi bi-check-lg"></i></label>
                                <div class="col">
                                  <span>{{ item.ack_desc }}</span>
                                  <p v-if="item.ack_taskchecklistcode_comments != ''" class="pre-line m-0">{{
                                    item.ack_taskchecklistcode_comments }}</p>
                                </div>
                                <button type="button" :id="'REFRESH'+item.ack_code" v-show="!data.status"
                                  class="ms-auto btn btn-sm rounded-circle btn-outline-secondary"
                                  @click="resetItems(item,$event)"><i class="bi bi-arrow-repeat"></i></button>
                                <i class="bi bi-circle pe-2"
                                  v-if="!getItemCompleted(item) && !item.updated && !item.process"></i>
                                <i class="bi bi-circle-fill pe-2"
                                  v-if="!getItemCompleted(item) && item.updated && !item.process"></i>
                                <i class="bi bi-circle text-info pe-2"
                                  v-if="!getItemCompleted(item) && item.updated && item.process"></i>
                                <i class="bi bi-check-circle pe-2"
                                  v-if="getItemCompleted(item) && !item.updated && !item.process"></i>
                                <i class="bi bi-check-circle-fill pe-2"
                                  v-if="getItemCompleted(item) && item.updated && !item.process"></i>
                                <i class="bi bi-check-circle-fill text-info pe-2"
                                  v-if="getItemCompleted(item) && item.updated && item.process"></i>
                              </div>
                              <div class="hstack gap-2 py-2" v-if="hasTextArea(item)">
                                <div class="w-100 form-floating me-auto">
                                  <textarea :ref="'NOTES'+item.ack_code" :id="'NOTES'+item.ack_code"
                                    :class="'form-control '+[ item.ack_notes == '' ? 'bg-warning-subtle' : '']"
                                    :disabled="data.status" v-model="item.ack_notes" @input="snycItems(item,$event)"
                                    @focus="snycItems(item,$event)" @keyup="snycItems(item,$event)"
                                    placeholder="..."></textarea>
                                  <label class="ps-4" :for="'NOTES'+item.ack_code">Notes</label>
                                </div>
                                <button :id="'PHOTO'+item.ack_code" type="button"
                                  :class="'btn btn-sm ' + [ getPhotoId(item.ack_code) == '' ? 'btn-outline-primary' : 'btn-primary']"
                                  data-bs-toggle="modal" data-bs-target="#newPage" @click="openPhoto(item)">
                                  <i class="bi bi-camera fs-4"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                          <div class="accordion-item" v-if="group.group_code === 'F-200105' && !data.status">
                            <div class="accordion-body py-3 row">
                              <div class="col-md hstack gap-2 fw-light">
                                <select class="form-select border-0 border-bottom" autocomplete="off"
                                  @change="selectFault" :disabled="data.status">
                                  <option value="">select a fault category</option>
                                  <option v-for="option in openFaults()" :value="option.value">
                                    {{ option.text }}
                                  </option>
                                </select>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="card-footer hstack gap-2 bg-light text-center p-3">
          <button v-show="!data.status" type="button" @click="submitForm()" :disabled="!getAllCompleted()"
            class="btn mx-auto w-50 btn-primary">
            <span v-if="!getAllCompleted() && data.snyc.length === 0">...</span>
            <span v-else-if="!getAllCompleted() && data.snyc.length !== 0">syncing...</span>
            <span v-else>Submit</span>
          </button>
          <button v-show="!data.status" type="button" @click="cancelForm()"
            class="btn mx-auto w-50 btn-secondary"><span>Cancel</span></button>
          <button v-show="data.status" type="button" @click="closeForm()"
            class="btn mx-auto w-50 btn-primary">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Optional JavaScript; choose one of the two! -->
  <!-- Option 1: Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>

  <script src="https://unpkg.com/vue@3.2.31/dist/vue.global.prod.js"></script>
  <script src="script.js"></script>
  <script src="module.js"></script>
  <script>

    var payload = [];
    var list = [];
    var metadata = [];
    var findings;
    var user_details;
    var equipment_details;
    var open_jobs;
    var dvr_forms;
    var alert_id = 0;
    var alert = Vue.createApp(alert_mod).mount("#alert");
    var checklist = Vue.createApp(form_mod).mount("#check");
    var form = Vue.createApp(checklist_mod).mount("#form");
    var photo_mgmt = Vue.createApp(photo_mod).mount("#photomodal");
    var jobs_mgmt = Vue.createApp(open_jobs_mod).mount("#openjobmodal");
    var job_button = document.getElementById('openjobmodalbutton');
    job_button.addEventListener("click", function (event) { jobs_mgmt.loaded = true });


    var dvr_mgmt = Vue.createApp(past_dvr_mod).mount("#pastdvrmodal");
    var dvr_button = document.getElementById('pastdvrmodalbutton');
    dvr_button.addEventListener("click", function (event) { dvr_mgmt.loaded = true });

    var param;
    var watching = {};
    var start = false;
    var gas = "https://script.google.com/macros/s/AKfycbym1Ko8WFpZJ1xIM9h2KlkDpvK5vavFrSvQYlF-qkK1JPtmjQfLic8OY0z2-19dIUDG/exec";

    function build_form(input) {
      var new_state = list.filter(function (e) { return e['ock_code'] == input })[0].state;
      if (new_state === 'Pre-Trip') { new_state = 'PRE' }
      if (new_state === 'Post-Trip') { new_state = 'POST' }
      var new_data = payload.filter(function (e) { return e['ock_code'] == input });
      if (new_state !== '') { new_data = new_data.filter(function (e) { return e['ack_reference'] == new_state || e['ack_reference'] === 'FAULTS' }) }
      new_data.forEach(function (e) { form.addItems(e) });
      form.loaded = true;
      checklist.form = true;
    }

    function loadmetadata(input) {
      var def = payload.filter(
        function (e) { return ['Unit/Fleet No', 'Registration No', 'Worker Name'].indexOf(e.ack_desc) != -1 && e.ock_status == 'U' }).filter(
          function (e) {
            if (e['ack_desc'] === 'Registration No' &&
              (e['ack_freetext'] === '' || e['ack_freetext'] === undefined)) { return e }
            if (e['ack_desc'] === 'Unit/Fleet No' &&
              (e['ack_freetext'] === '' || e['ack_freetext'] === undefined)) { return e }
            if (e['ack_desc'] === 'Worker Name' &&
              (e['ack_freetext'] === '' || e['ack_freetext'] === undefined)) { return e }
          });
      if (def.length != 0) {
        def.map(
          function (e) { return e.ack_code }).forEach(
            function (e) { document.getElementById('REFRESH' + e).click() })
      }
      var time = payload.filter(
        function (e) {
          return e.ack_desc === 'Date'
            && (e.ack_checklistdatetime === ''
              || e.ack_checklistdatetime === undefined)
            && e.ack_reference == input.reference
            && e.ock_code == input.ock_code
            && e.ock_status == 'U'
        });
      if (time.length != 0) {
        time.map(
          function (e) { return e.ack_code }).forEach(
            function (e) {
              var input_time = document.getElementById('FREE' + e);
              input_time.value = (new Date()).toJSON().substring(0, 16);
              var evt = new Event('input');
              input_time.dispatchEvent(evt)
            })
      }
    }

    function build_new_form() {
      checklist.loaded = false;
      var req_param = gas + '?process=add_checklist&tenant=' + param.tenant + '&organization='
        + param.organization + '&equipmentno=' + param.equipmentno + '&userid=' + param.userid;

      var new_req = new Request(req_param, {
        redirect: "follow",
        method: 'POST',
        headers: {
          "Content-Type": "text/plain;charset=utf-8",
        },
      });
      fetch(new_req)
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.status != undefined && data.status === false) {
            alert.add({
              text: data.text,
              type: 'error'
            })
          }
          else { get_forms() }
        })
    }

    function closeForm() { get_forms() }

    function send_form(input) {
      checklist.loaded = false;
      form.loaded = false
      payload.filter(
        function (e) {
          return e.ack_desc === 'Date'
            && e.ack_reference == input.reference
            && e.ock_code == input.ock_code
        }).map(
          function (e) { return e.ack_code }).forEach(
            function (e) {
              var input_time = document.getElementById('FREE' + e);
              input_time.value = (new Date()).toJSON().substring(0, 16);
              var evt = new Event('input');
              input_time.dispatchEvent(evt)
            });
      var check = function () {
        if (form.getAllCompleted()) {
          if (input.reference == 'PRE') { get_forms() }
          else {
            if (!start) {
              start = true;
              var req_comp_param = gas + '?process=complete_checklist&tenant=' + param.tenant + '&organization='
                + param.organization + '&checklist=' + input.ock_code + '&userid=' + param.userid;

              var upd_checklist_req = new Request(req_comp_param, {
                redirect: "follow",
                method: 'POST',
                headers: {
                  "Content-Type": "text/plain;charset=utf-8",
                },
              });
              fetch(upd_checklist_req)
                .then(function (response) {
                  return response.json();
                })
                .then(function (data) {
                  if (data.status != undefined && data.status === false) {
                    alert.add({
                      text: data.text,
                      type: 'error'
                    })
                  }
                  else { get_forms() }
                });
            }
          }
        }
        else { setTimeout(check, 250) }
      }
      check();
    }

    function cancel_form(input) {
      checklist.loaded = false;
      form.loaded = false
      var req_comp_param = gas + '?process=cancel_checklist&tenant=' + param.tenant + '&organization='
        + param.organization + '&checklist=' + input.ock_code + '&userid=' + param.userid;

      var upd_checklist_req = new Request(req_comp_param, {
        redirect: "follow",
        method: 'POST',
        headers: {
          "Content-Type": "text/plain;charset=utf-8",
        },
      });
      fetch(upd_checklist_req)
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.status != undefined && data.status === false) {
            alert.add({
              text: data.text,
              type: 'error'
            })
          }
          else { get_forms() }
        });
    }

    function fix_time(org) {
      var date = new Date();
      var option = {
        year: "numeric",
        month: "short",
        day: "numeric"
      };
      var orgs = ['TAS', 'WAU', 'NWA', 'WAR', 'SAU', 'VIC', 'NSW', 'TAS', 'NTE'];
      var options = {};
      orgs.forEach(function (e) {
        options[e] = JSON.parse(JSON.stringify(option))
      });
      options['TAS']['timeZone'] = 'Australia/Hobart';
      options['VIC']['timeZone'] = 'Australia/Melbourne';
      options['WAR']['timeZone'] = 'Australia/Perth';
      options['WAU']['timeZone'] = 'Australia/Perth';
      options['NWA']['timeZone'] = 'Australia/Perth';
      options['SAU']['timeZone'] = 'Australia/Adelaide';
      options['NSW']['timeZone'] = 'Australia/Sydney';
      options['QLD']['timeZone'] = 'Australia/Brisbane';
      options['NTE']['timeZone'] = 'Australia/Darwin';
      return (date).toLocaleString('en-GB', options[org]).toUpperCase()
    }

    function isMobile() {
      var check = false;
      (function (a) {
        if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4)))
          check = true;
      })(navigator.userAgent || navigator.vendor || window.opera);
      return check;
    };

    function get_forms() {
      photo_mgmt.init();
      form.init();
      checklist.init();
      payload = [];
      fetch(updateUrl(gas, param))
        .then(function (response) { return response.json() })
        .then(function (data) {
          if (data.status != undefined && data.status === false && data.text !== 'query returns null') {
            alert.add({ text: data.text, type: 'error' });
            form.broken = true;
            checklist.broken = true;
          }
          else {
            if (data.text === 'query returns null') { data = [] }
            else { data = data.text }
            data = data.filter(function (e) { return e['ock_code'] != undefined });
            data.forEach(function (e) {
              if (e['ack_value'] != undefined) { e['ack_value'] = e['ack_value'].replaceAll(',', '') }
            });
            payload = payload.concat(data);
            var reform = payload.map(function (e) {
              var rep = {};
              rep['obj_org'] = e['obj_org'];
              rep['obj_code'] = e['obj_code'];
              rep['obj_desc'] = e['obj_desc'];
              rep['obj_udfchar39'] = e['obj_udfchar39'];
              rep['ock_status'] = e['ock_status'];
              rep['ock_status_desc'] = e['ock_status_desc'];
              rep['trunc_ock_startdate'] = e['trunc_ock_startdate'];
              rep['ock_code'] = e['ock_code'];
              return rep
            });
            var new_ref = [...new Map(reform.map(item =>
              [item['ock_code'], item])).values()];

            if (new_ref.length > 0) {
              new_ref.forEach(function (e) {
                if (e['ock_status'] == 'U') {
                  var req = payload.filter(function (f) { return f['ack_requiredtoclose'] === 'YES' && f['ock_code'] === e['ock_code'] });
                  var req_pre = req.filter(function (f) { return f['ack_reference'] === 'PRE' && f['ock_code'] === e['ock_code'] });
                  var req_post = req.filter(function (f) { return f['ack_reference'] === 'POST' && f['ock_code'] === e['ock_code'] });
                  var current_pre = req_pre.filter(function (f) {
                    if (f['ack_type'] == '01' && f['ack_completed'] != undefined && f['ack_completed'] != '-') { return f }
                    if (f['ack_type'] == '02' && f['ack_yes'] != undefined && f['ack_no'] != undefined) { return f }
                    if (f['ack_type'] == '03' && f['ack_finding'] != undefined) { return f }
                    if (f['ack_type'] == '04' && f['ack_value'] != undefined) { return f }
                    if (f['ack_type'] == '13' && f['ack_checklistdate'] != undefined) { return f }
                    if (f['ack_type'] == '14' && f['ack_checklistdatetime'] != undefined) { return f }
                    if (f['ack_type'] == '15' && f['ack_freetext'] != undefined) { return f }
                  });
                  if (current_pre.length == req_pre.length) {
                    e['state'] = 'Post-Trip'
                  } else { e['state'] = 'Pre-Trip' }
                } else { e['state'] = '' }
              })
            }
            list = list.concat(new_ref);
            new_ref.forEach(function (e) { checklist.addItems(e) });
            checklist.loaded = true;
          }
        });
    }

    function get_findings() {
      var findings_url = gas + '?process=get_findings&tenant=' + param.tenant + '&userid=' + param.userid;
      var findings_req = new Request(findings_url, {
        redirect: "follow",
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      fetch(findings_req)
        .then(function (response) { return response.json() })
        .then(function (data) {
          if (data.status != undefined && data.status === false) { alert.add({ text: data.text, type: 'error' }) }
          else { findings = data.text }
        });
    }

    function get_user_details() {
      var user_details_url = gas + '?process=get_user_details&tenant=' + param.tenant + '&userid=' + param.userid;
      var user_details_req = new Request(user_details_url, {
        redirect: "follow",
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      fetch(user_details_req)
        .then(function (response) { return response.json() })
        .then(function (data) {
          if (data.status != undefined && data.status === false) { alert.add({ text: data.text, type: 'error' }) }
          else { user_details = data.text.pop() }
        });
    }

    function get_equipment_details() {
      var equipment_details_url = gas + '?process=get_equipment_details&tenant=' + param.tenant +
        '&userid=' + param.userid + '&organization=' + param.organization + '&equipmentno=' + param.equipmentno;
      var equipment_details_req = new Request(equipment_details_url, {
        redirect: "follow",
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      fetch(equipment_details_req)
        .then(function (response) { return response.json() })
        .then(function (data) {
          if (data.status != undefined && data.status === false) { alert.add({ text: data.text, type: 'error' }) }
          else { equipment_details = data.text.pop() }
        });
    }

    function get_open_jobs() {
      var open_jobs_url = gas + '?process=get_open_jobs&tenant=' + param.tenant +
        '&userid=' + param.userid + '&organization=' + param.organization;
      if (equipment_details['obj_position'] === undefined || equipment_details['obj_position'] === '') {
        open_jobs_url = open_jobs_url + '&parentcode=null' + '&equipmentno=' + param.equipmentno;
      }
      else {
        open_jobs_url = open_jobs_url + '&parentcode=' + equipment_details['obj_position'] + '&equipmentno=null';
      }
      var open_jobs_req = new Request(open_jobs_url, {
        redirect: "follow",
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      fetch(open_jobs_req)
        .then(function (response) { return response.json() })
        .then(function (data) {
          if (data.status != undefined && data.status === false) {
            if (data.text !== 'query returns null') { alert.add({ text: data.text, type: 'error' }) }
            open_jobs = [];
            var count = jobs_mgmt.getData().length;
            document.getElementById('openjobmodalcount').innerHTML = count;
            if (count > 0) { job_button.classList.remove('disabled') }
          }
          else {
            open_jobs = data.text;
            open_jobs.forEach(function (e) { jobs_mgmt.addItems(e) });
            var count = jobs_mgmt.getData().length;
            document.getElementById('openjobmodalcount').innerHTML = count;
            if (count > 0) { job_button.classList.remove('disabled') }
          }
        });
    }

    function get_past_dvr() {
      var dvr_forms_url = gas + '?process=get_forms&tenant=' + param.tenant +
        '&userid=' + param.userid + '&organization=' + param.organization;
      if (equipment_details['obj_position'] === undefined || equipment_details['obj_position'] === '') {
        dvr_forms_url = dvr_forms_url + '&parentcode=null' + '&equipmentno=' + param.equipmentno;
      }
      else {
        dvr_forms_url = dvr_forms_url + '&parentcode=' + equipment_details['obj_position'] + '&equipmentno=null';
      }
      var dvr_forms_req = new Request(dvr_forms_url, {
        redirect: "follow",
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      fetch(dvr_forms_req)
        .then(function (response) { return response.json() })
        .then(function (data) {
          if (data.status != undefined && data.status === false) {
            if (data.text !== 'query returns null') { alert.add({ text: data.text, type: 'error' }) }
            dvr_forms = [];
            var count = dvr_mgmt.getData().length;
            document.getElementById('pastdvrmodalcount').innerHTML = count;
            if (count > 0) { dvr_button.classList.remove('disabled') }
          }
          else {
            dvr_forms = data.text;
            dvr_forms.forEach(function (e) { dvr_mgmt.addItems(e, gas) });
            dvr_mgmt.getQueue();
            var count = dvr_mgmt.getData().length;
            document.getElementById('pastdvrmodalcount').innerHTML = count;
            if (count > 0) { dvr_button.classList.remove('disabled') }
          }
        });
    }

    (function () {
      param = getAllUrlParams();
      if (param.equipmentno == undefined || param.equipmentno == '' || param.organization == undefined || param.organization == '' ||
        param.tenant == undefined || param.tenant == '' || param.userid == undefined || param.userid == '') {
        alert.add({
          text: 'incomplete request',
          type: 'error'
        });
        form.broken = true;
        checklist.broken = true;
      }
      else if (['TAS', 'WAU', 'NWA', 'WAR', 'SAU', 'VIC', 'NSW', 'TAS', 'NTE'].indexOf(param.organization) == -1) {
        alert.add({
          text: 'This function not applicable for this organization',
          type: 'error'
        });
        form.broken = true;
        checklist.broken = true;
      }
      else {
        var initial_req = new Request(gas + '?process=get_inital&tenant=' + param.tenant +
          '&userid=' + param.userid + '&organization=' + param.organization + '&equipmentno=' + param.equipmentno, {
          redirect: "follow",
          method: 'POST',
          headers: { "Content-Type": "text/plain;charset=utf-8" },
        });
        fetch(initial_req)
          .then(function (response) { return response.json() })
          .then(function (data) {
            if (data.status != undefined && data.status === false) {
              alert.add({ text: data.text, type: 'error' })
            }
            else {

              findings = data.text.findings.text;
              user_details = data.text.user_details.text.pop();
              equipment_details = data.text.equipment_details.text.pop();
              get_forms();
              get_open_jobs();
              get_past_dvr();
            }
          });
      }
    })();
  </script>
</body>

</html>